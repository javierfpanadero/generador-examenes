<!DOCTYPE html>
<html lang=es>

<head>
    <meta charset=utf-8>
    <title>Generador de exámenes</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description"
        content="Programa para generar exámenes con preguntas de respuesta múltiple con valores variables, para imprimir y para Moodle">
    <meta name="author" content="Javier F. Panadero">
    <script src="https://cdn.jsdelivr.net/pyodide/v0.20.0/full/pyodide.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@latest/css/pico.min.css">
</head>

<body>
    <main class="container">
        <h2>Generador de exámenes</h2>
        <h5>Por <a href="https://twitter.com/javierfpanadero">Javier F. Panadero</a></h5>
        <p>Instrucciones:</p>
        <ol>
            <li>Prepara el examen de entrada (examen de ejemplo: <a href="examen.txt">examen.txt</a>).</li>
            <li>Elige un formato (papel o moodle) y sube el examen de entrada.</li>
            <li>Descarga el examen de salida.</li>
        </ol>
        <h3>Programa</h3>
        <p id="status">Cargando...</p>

        <form hidden>
            <label for="entrada">Entrada:</label>
            <input id="entrada" name="entrada" type="file" accept=".txt" required>

            <fieldset>
                <legend>Elige un formato de salida:</legend>

                <div>
                    <input type="radio" id="papel" name="script" value="papel.py" checked>
                    <label for="papel">Papel (.txt)</label>
                </div>

                <div>
                    <input type="radio" id="moodle" name="script" value="moodle.py">
                    <label for="moodle">Moodle (.xml)</label>
                </div>
            </fieldset>

            <button type="submit">Descargar</button>
        </form>
        <h3>Manuales de uso</h3>
        <ul>
            <li><a
                    href="https://lacienciaparatodos.wordpress.com/2021/12/12/creacion-de-examenes-respuesta-multiple-con-diferentes-valores/">Papel</a>
            </li>
            <li><a
                    href="https://lacienciaparatodos.wordpress.com/2021/12/15/programa-para-subir-a-moodle-preguntas-de-respuesta-multiple-con-valores-variables/">Moodle</a>
            </li>
        </ul>
    </main>
    <script type="text/javascript">
        const OUTPUT_FILENAMES = {
            'papel.py': 'output.txt',
            'moodle.py': 'salida.xml'
        }
        const SCRIPTS = {};
        const statusEl = document.getElementById('status');
        var pyodide = null;

        // Cargar los scripts y Pyodide
        Promise.all([
            fetch('papel.py').then(res => res.text()),
            fetch('moodle.py').then(res => res.text()),
            loadPyodide(),
        ]).then(([papel, moodle, _pyodide]) => {
            // Guardar los scripts
            SCRIPTS['papel.py'] = papel;
            SCRIPTS['moodle.py'] = moodle;

            // Habilitar la interfaz
            document.forms[0].hidden = false;
            statusEl.innerHTML = "";

            // Asignar pyodide
            pyodide = _pyodide
            console.log("Pyodide ready");
        });

        // Función ejecutada al subir el archivo
        function processForm(e) {
            e.preventDefault();
            statusEl.innerHTML = "Produciendo exámen...";
            
            // Obtener los valores del formulario
            const formData = new FormData(e.target);
            const scriptName = formData.get('script');
            const entrada = document.getElementById('entrada');
            const outputFilename = OUTPUT_FILENAMES[scriptName];

            // Leer el examen subido
            var inputFile = entrada.files[0];
            var reader = new FileReader();
            reader.readAsText(inputFile);
            reader.onload = evt => {
                try {
                    // Escribir el examen de entrada en el sistema de archivos virtual de Pyodide
                    var inputContent = evt.target.result;
                    pyodide.FS.writeFile("examen.txt", inputContent, { encoding: "utf8" });

                    // Ejecutar el script
                    pyodide.globals.clear()
                    var debug = pyodide.runPython(SCRIPTS[scriptName]);
                    console.log(debug) // Podemos ver la salida de texto del script en la consola

                    // Leer el examen de salida del sistema de archivos virtual de Pyodide
                    let outputContent = pyodide.FS.readFile(outputFilename, { encoding: "utf8" });
                    var outputLength = outputContent.length;
                    var outputEncoded = new Uint8Array(outputLength);
                    for (var i = 0; i < outputLength; i++) {
                        outputEncoded[i] = outputContent.charCodeAt(i);
                    }

                    // Disparar la descarga del archivo en el navegador creando un elemento temporal
                    var blob = new Blob([outputEncoded], { type: 'application/octet-stream' });
                    var elem = window.document.createElement('a');
                    elem.href = window.URL.createObjectURL(blob);
                    elem.download = outputFilename;
                    document.body.appendChild(elem);
                    elem.click();
                    document.body.removeChild(elem);
                    statusEl.innerHTML = "";
                }
                catch (err) {
                    statusEl.innerHTML = "Error al producir el exámen: " + err.message;
                } finally {
                    pyodide.FS.unlink("examen.txt");
                }
            }
            return false;
        }

        // Generar el examen al enviar el formulario
        var form = document.forms[0];
        form.addEventListener("submit", processForm);

    </script>
</body>